#VRML V2.0 utf8

WorldInfo {
	title "Store room"
	info ["Eva Pešková"]
}

EXTERNPROTO	LadyBugProto [
	exposedField SFInt32 lod
]
"ladyBugLods.wrl#LadyBug"

EXTERNPROTO ApartmentProto [
	exposedField SFInt32 lod 
	exposedField SFNode windowTexture
	exposedField SFInt32 zCeilingRotation
]
"apartment.wrl#Apartment"


PROTO CrateC [
	exposedField SFVec3f initialPosition 0 0 0
	exposedField SFInt32 lod 1
]{
	Group {
		children [
			Switch {
				choice [
					DEF Crate Shape {
						geometry Box {
							size 1 1 1
						}
						appearance Appearance {	 
										texture	ImageTexture {
											url	["..\textures\wood.jpeg"]
										}
									}
					}
				    
					DEF	CrateMove Transform {
    				rotation 1 0 0 -1.57         # rotate back to the original plane
    				translation IS initialPosition  # iniciální poloha lampy na stole
    				children [
    					DEF CrateChangePos PlaneSensor { maxPosition 2 2 minPosition -2 -2}

        				DEF CrateSensored Transform { 
        					rotation 1 0 0 1.57  # rotate to the place that we want to move in
        					children USE Crate
        				}
					]		
				}
				]
			}
			USE	CrateMove
		]																 
	}

	ROUTE CrateChangePos.translation_changed TO CrateSensored.translation
}

PROTO BarrelProto [
	exposedField SFInt32 lod 1
]{
	Group {
		children [
			Switch {
				choice [	 
					DEF	TopCylinder Transform {
						children [
							Transform  {
								children 
								[ Shape {
								geometry Cylinder {
									height 0.02
									radius 0.4
									top	TRUE
									bottom TRUE
								}	 
									appearance Appearance {	 
										texture	ImageTexture {
											url	["..\textures\wood.jpeg"]
										}
									}

								}
								Sound {
									source DEF CrateAudioClip AudioClip {
										url	["../wav/crateOpen.wav"]
										description	"OpeningCrate"
									}
									maxBack	1000
									maxFront 1000
								}
							]

								translation	0 0.5 0
							}
							
							DEF	BarrelLidSensor TouchSensor {}	 

						DEF BarrelLidPosition PositionInterpolator	{	## for the lid
							key [0, 1]
							keyValue [ 0 0 0, 0 1 0 ]
						}

						DEF BarrelLidOrientation OrientationInterpolator	{
							key [0, 1]
							keyValue [1 0 0 0, 1 0 0 1.8]
						}

						DEF BarrelSensor TimeSensor {
						
									#how much the interval should take
									cycleInterval 0.5	

									#for barrel, repeat just once
									#loop TRUE
								}							
						]				   
					}								
					

					DEF	Barrel Transform {
						children [
								Inline	{
									url	["../blend/barrel.wrl"]
							}					
							# Add top cylinder that can be moved
							USE	TopCylinder
						]
					}
				]
			}
			USE	Barrel
		]
	}
	ROUTE BarrelLidSensor.touchTime TO CrateAudioClip.startTime
	ROUTE BarrelLidSensor.touchTime	TO BarrelSensor.startTime
	ROUTE BarrelSensor.fraction_changed	TO BarrelLidOrientation.set_fraction
	ROUTE BarrelSensor.fraction_changed	TO BarrelLidPosition.set_fraction
	ROUTE BarrelLidOrientation.value_changed TO	TopCylinder.rotation
	ROUTE BarrelLidPosition.value_changed TO TopCylinder.translation 
}	

PROTO BarrelLiquid [
	exposedField SFInt32 lod 1
	exposedField SFColor color 0 0.1 0.8
	exposedField SFFloat tranp 0.2	
]{
	Group {
		children [
			Switch {
			   choice [
				   DEF	BarrelWater Transform {
						children [
							BarrelProto	{ lod IS lod }
							Transform {
								children Shape {
									appearance Appearance {
										material DEF Water Material {
											diffuseColor IS	color
											transparency IS	tranp
										}
									}
									geometry Cylinder {
										radius 0.4
										height 0.1
										top	TRUE
									}
								}
								# water is somewhere up
								translation	0 0.15 0
							}							
						]
					}
			   ]
			}
			USE	BarrelWater	
		]
	}
}

PROTO StoreRoom [
	exposedField SFInt32 lod 1
]{
	Group {
		children [
			Switch {
				choice [
					DEF ApartmentInstance ApartmentProto {
						lod	IS lod		
					}
				]		   
			}
			Transform {
					children [
						
						Transform {
							children	[
								USE	ApartmentInstance
								CrateC	{
									initialPosition	1 0 1
								}
								CrateC {
									initialPosition	0 0 2
								}
								CrateC {
									initialPosition	-1 0 -1
								}
								BarrelProto	{}
								Transform {
									children [
										BarrelLiquid { tranp 0.1 }
									]
									translation	0 0 -2
								}
							]
																							   			  
							
						}
							  
						Transform {
							children [
								Transform {
									children [
										Viewpoint {
											description	"Store room"
											orientation	1 0 0 -1.18
											position 1.2 0.5 0
											jump FALSE
										}
										Viewpoint {
											description	"Inside StoreRoom"
											orientation	0 0 1 0
											position -0.2 -2.2 1.2
											jump FALSE
										}
								]
								rotation 0 1 0 -0.60
							}
						]
						# Translastion of the balcony platform
						translation	0 2.9 0
					}

				]
				#all is moved  "down" so that the ceiling is at "0"
				translation	0 -2.9 0
			}
		]
	}
}
