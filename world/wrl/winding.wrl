#VRML V2.0 utf8

WorldInfo {
	title "Winding mechanism"
	info ["Filip BÃ¡rtek"]
}

# http://www.bellrock.org.uk/lighthouse/lighthouse_lightroom.htm (looks, dimensions)
# http://www.bellrock.org.uk/lighthouse/lighthouse_courses.htm (position)

EXTERNPROTO	BarSquareProto [
	exposedField SFInt32 lod
	field SFVec3f size
	exposedField SFColor diffuseColor
	exposedField SFNode texture
]
"barsquare.wrl#BarSquare"

EXTERNPROTO	CylinderShape [
	field SFNode appearance
	exposedField SFInt32 lod
	field MFFloat range
	field SFFloat radius
	eventIn	SFFloat	set_radius
	field SFFloat height
	eventIn	SFFloat	set_height
	field SFBool top
	field SFBool bottom
	field SFBool solid
	field SFFloat creaseAngle
	field SFInt32 complexity
]
"cylindershape.wrl#CylinderShape"

Switch {
	choice [
		DEF	Drum Transform {
			children [
				CylinderShape {
					appearance Appearance {
						material Material {
							diffuseColor 0.4 0.2 0.1
						}
					}
					range [200 400]
				}
			]
			scale 0.2 0.2 0.2
		}
		DEF	Hinge Transform	{
			children [
				Transform {
					children [
						Transform {
							children [
								Transform {
									children BarSquareProto {
										diffuseColor 0.1 0.1 0.2
										size 0.05 1 0.05
									}
									translation	0.025 0.5 0
								}
								Transform {
									children Transform {
										children CylinderShape {
											appearance Appearance {
												material Material {
													diffuseColor 0.1 0.1 0.2
												}
											}
											radius 0.025
											height 1
											bottom FALSE
										}
										translation	0 0.5 0
									}
									rotation 0 0 1 -1.57
									translation	0 0.975 0
								}
							]
						}
					]
					scale 0.4 0.4 0.4
					rotation 0 0 1 1.57
				}
				DEF HingeCS CylinderSensor	{
					enabled	FALSE
					minAngle 0
					maxAngle 25.13
				}
			]
			rotation 0 0 1 -1.57
		}
		DEF	RopeAppearance Appearance {
			material Material {
				diffuseColor 0.8 0.8 0
			}
		}
		DEF	RopeCoil Transform {
			children DEF RopeCylinder CylinderShape {
				appearance USE RopeAppearance
				height 0.05
				radius 0.21
			}
		}
	]
}

Transform {
	children DEF	Winding Transform {
		children Transform {
			children [
				Transform {
					children [
						USE	Drum
						USE	RopeCoil
					]
					rotation 0 0 1 1.57
				}
				Transform {
					children USE Hinge
					translation	0.2 0 0
				}
			]
			rotation 0 0 1 1.57
		}
	}
	rotation 0 0 1 -1.57
}

DEF PS ProximitySensor	{
	size 3 3 3
}

DEF	RopeScript Script {
	eventIn SFRotation rot
	field SFNode coil USE RopeCylinder
	field SFFloat heightMin 0.05
	field SFFloat heightMax 0.35
	field SFFloat angleMin 0
	field SFFloat angleMax 25.13
	url	"javascript:
		function rot(value) {
			var angle = value[3];
			var angle01 = (angle - angleMin) / (angleMax - angleMin);
			var height = heightMin + (heightMax - heightMin) * angle01;
			coil.set_height = height;
		}
	"
	directOutput TRUE
}

ROUTE PS.isActive TO HingeCS.enabled
ROUTE HingeCS.rotation_changed TO Winding.rotation
ROUTE HingeCS.rotation_changed TO RopeScript.rot
